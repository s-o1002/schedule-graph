<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>グラフプロトタイプ</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      /* ↓操作しづらい部分があるため追加してる */
      user-select: none;
    }

    .schedule {
      position: absolute;
      top: 50px;
      height: 50px;
      background-color: #009688;
      opacity: 0.7;
      cursor: grab;
    }

    .ruler {
      top: 0;
      width: 1440px;
      height: 50px;
      border-bottom: 1px solid #ddd;
      box-sizing: border-box;
      font-size: 12px;
      text-align: center;
      line-height: 50px;
      user-select: none;
    }

    .ruler-mark {
      position: absolute;
      top: 35px;
      width: 1px;
      height: 15px;
      background-color: #ddd;
    }

    .ruler-label {
      position: absolute;
      top: 0;
      width: 50px;
      height: 50px;
      line-height: 50px;
    }

    #param {
      user-select: none;
      margin: 80px 0 0 0px;
    }

    .highlight {
      background-color: yellow;
    }

    body {
      margin-left: 50px;
    }

    #selectedParam {
      width: 25%;
    }
  </style>
</head>

<body>
  <div class="ruler">
    <div class="ruler-mark" style="left: 0;"></div>
    <div class="ruler-label" style="left: 25px;">0:00</div>
    <div class="ruler-mark" style="left: 50px;"></div>
    <div class="ruler-label" style="left: 85px;">1:00</div>
    <div class="ruler-mark" style="left: 110px;"></div>
    <div class="ruler-label" style="left: 145px;">2:00</div>
    <div class="ruler-mark" style="left: 170px;"></div>
    <div class="ruler-label" style="left: 205px;">3:00</div>
    <div class="ruler-mark" style="left: 230px;"></div>
    <div class="ruler-label" style="left: 265px;">4:00</div>
    <div class="ruler-mark" style="left: 290px;"></div>
    <div class="ruler-label" style="left: 325px;">5:00</div>
    <div class="ruler-mark" style="left: 350px;"></div>
    <div class="ruler-label" style="left: 385px;">6:00</div>
    <div class="ruler-mark" style="left: 410px;"></div>
    <div class="ruler-label" style="left: 445px;">7:00</div>
    <div class="ruler-mark" style="left: 470px;"></div>
    <div class="ruler-label" style="left: 505px;">8:00</div>
    <div class="ruler-mark" style="left: 530px;"></div>
    <div class="ruler-label" style="left: 565px;">9:00</div>
    <div class="ruler-mark" style="left: 590px;"></div>
    <div class="ruler-label" style="left: 625px;">10:00</div>
    <div class="ruler-mark" style="left: 650px;"></div>
    <div class="ruler-label" style="left: 685px;">11:00</div>
    <div class="ruler-mark" style="left: 710px;"></div>
    <div class="ruler-label" style="left: 745px;">12:00</div>
    <div class="ruler-mark" style="left: 770px;"></div>
    <div class="ruler-label" style="left: 805px;">13:00</div>
    <div class="ruler-mark" style="left: 830px;"></div>
    <div class="ruler-label" style="left: 865px;">14:00</div>
    <div class="ruler-mark" style="left: 890px;"></div>
    <div class="ruler-label" style="left: 925px;">15:00</div>
    <div class="ruler-mark" style="left: 950px;"></div>
    <div class="ruler-label" style="left: 985px;">16:00</div>
    <div class="ruler-mark" style="left: 1010px;"></div>
    <div class="ruler-label" style="left: 1045px;">17:00</div>
    <div class="ruler-mark" style="left: 1070px;"></div>
    <div class="ruler-label" style="left: 1105px;">18:00</div>
    <div class="ruler-mark" style="left: 1130px;"></div>
    <div class="ruler-label" style="left: 1165px;">19:00</div>
    <div class="ruler-mark" style="left: 1190px;"></div>
    <div class="ruler-label" style="left: 1225px;">20:00</div>
    <div class="ruler-mark" style="left: 1250px;"></div>
    <div class="ruler-label" style="left: 1285px;">21:00</div>
    <div class="ruler-mark" style="left: 1310px;"></div>
    <div class="ruler-label" style="left: 1345px;">22:00</div>
    <div class="ruler-mark" style="left: 1370px;"></div>
    <div class="ruler-label" style="left: 1405px;">23:00</div>
    <div class="ruler-mark" style="left: 1430px;"></div>
    <div class="ruler-label" style="left: 1465px;">24:00</div>
    <div class="ruler-mark" style="left: 1490px;"></div>
  </div>
  <div id="scheduleBox">
  </div>
  <div id="param">
    <fieldset id="selectedParam">
      <legend>選択パラメータ</legend>
      開始：<input type="time" id="start" name="example" value="" readonly><br><br>
      終了：<input type="time" id="end" name="example" value="" readonly>
      <p id="total">長さ:</p>
    </fieldset>


    最小単位(分)：<select id="select">
      <option value="1">1</option>
      <option value="5">5</option>
      <option value="10">10</option>
      <option value="15" selected>15</option>
      <option value="30">30</option>
      <option value="60">60</option>
    </select>

    <br>
    <br>

    <button id="add">Add</button>
  </div>

  <br>
  <div id="results">
    <!-- saveボタンで最終を開始、終了ログでまとめられるようにしたい。以下ダミー -->
    <button>save</button>
    <ul>
      <li>hh:mm 開始</li>
      <li>hh:mm 終了</li>
      <li>hh:mm 再開</li>
      <li>hh:mm 終了</li>
    </ul>
  </div>

  <script>
    const schedules = [];
    let newId = schedules.length;
    let selectedElement = null;
    let selectedClassInstance = null;
    let minWidth = 15;
    const limitScheduleNum = 10;

    const select = document.getElementById("select");
    select.addEventListener("change", function () {
      minWidth = Number(select.value);
      this.blur();
    });

    function highlightElement(element) {
      if (selectedElement && selectedElement != element) {
        selectedElement.classList.remove("highlight");
      }
      if (selectedElement != element) {
        selectedElement = element;
        selectedElement.classList.add("highlight");
      }
      findInstanceByElement(element);
    }

    window.addEventListener("load", function () {
      var start = document.getElementById("start");
      var end = document.getElementById("end");

      start.addEventListener("input", function (event) {
        selectedClassInstance.setStartTime(event.target.value);
      });

      end.addEventListener("input", function (event) {
        selectedClassInstance.setEndTime(event.target.value);
      });

      var addButton = document.getElementById("add");
      addButton.addEventListener("click", function (event) {
        addEvent();
      });

      document.addEventListener("keydown", function (event) {
        const key = event.key;
        if (event.shiftKey && event.key === "ArrowLeft" && selectedClassInstance) {
          // console.log("Shift + 左矢印キーが同時に押されました。");
          selectedClassInstance.shrinkBack();
        } else if (event.shiftKey && event.key === "ArrowRight" && selectedClassInstance) {
          // console.log("Shift + 右矢印キーが同時に押されました。");
          selectedClassInstance.extendBack();
        } else if (event.key === "n") {
          addEvent();
        } else if (key === "ArrowLeft" && selectedClassInstance) {
          // 左キーが押されたときの処理
          // console.log("left");
          selectedClassInstance.LeftArrow();
        } else if (key === "ArrowRight" && selectedClassInstance) {
          // 右キーが押されたときの処理
          // console.log("right");
          selectedClassInstance.RightArrow();
        } else if (key === 'Tab') {
          // カスタム動作を行う
          if (selectedClassInstance && schedules.length > 1) {
            event.preventDefault();
            focusNext();
          }
        }
      });
    });

    class scheduleClass {
      constructor(scheduleId) {
        // コンストラクター
        this.schedule = document.getElementById(scheduleId);

        this.schedule.addEventListener('mousemove', e => {
          this.cursorX = e.clientX;
          this.cursorY = e.clientY;
          this.rect = this.schedule.getBoundingClientRect();
          this.scheduleCenterX = this.rect.left + this.rect.width / 2;
          this.scheduleCenterY = this.rect.top + this.rect.height / 2;

          if (this.cursorX < this.rect.left + 10 || this.cursorX > this.rect.right - 10) {
            this.schedule.style.cursor = 'ew-resize';
          } else if (Math.abs(this.cursorX - this.scheduleCenterX) < 10 && Math.abs(this.cursorY - this.scheduleCenterY) < 10) {
            if (this.isDragging) {
              this.schedule.style.cursor = 'grabbing';
            } else {
              this.schedule.style.cursor = 'grab';
            }
          } else {
            if (this.isDragging) {
              this.schedule.style.cursor = 'grabbing';
            } else {
              this.schedule.style.cursor = 'grab';
            }
          }
        });
        this.isDragging = false;
        this.isResizingLeft = false;
        this.isResizingRight = false;
        this.startX = 0;
        this.startWidth = this.schedule.clientWidth;
        //最小単位(分)
        // minWidth = 30;
        this.startleft = parseInt(this.schedule.style.left);
        this.styleleft = parseInt(this.schedule.style.left);
        this.startP = document.getElementById("start");
        this.endP = document.getElementById("end");
        this.totalP = document.getElementById("total");

        this.schedule.addEventListener('mousedown', (event) => {
          if (event.button === 0) {
            highlightElement(this.schedule);
            this.schedule.style.cursor = 'grabbing';
            if (event.offsetX < 10) {
              this.isResizingLeft = true;
            } else if (event.offsetX > this.schedule.clientWidth - 10) {
              this.isResizingRight = true;
            } else {
              this.isDragging = true;
            }
            this.startX = event.pageX;
            this.startleft = parseInt(this.schedule.style.left);
            this.styleleft = parseInt(this.schedule.style.left);
            this.startWidth = this.schedule.clientWidth;
            // console.log(this.startWidth);
            this.showParam(this.startWidth);
            // console.log("down");
          }
        });
        this.schedule.addEventListener('click', (event) => {
          if (event.button === 0) {
            this.schedule.style.cursor = 'grab';
          }
        });

        document.addEventListener('mousemove', (event) => {
          if (this.isResizingLeft) {
            const newWidth = this.startWidth + this.startX - event.pageX;
            this.styleleft = this.startleft + this.startWidth - newWidth;
            // console.log(this.styleleft);
            if (newWidth >= minWidth && event.pageX > 0 && this.styleleft > 50 && newWidth % minWidth == 0) {
              this.schedule.style.width = `${newWidth}px`;
              this.schedule.style.left = `${this.styleleft}px`;
              this.showParam(newWidth);
            }
            // console.log("left");
            // console.log("startleft:"+startleft);
            // console.log("styleleft:"+styleleft);
            // console.log("event.pageX:"+event.pageX);
            // console.log("startX:"+startX);
            // console.log("startWidth:"+startWidth);
            // console.log("newWidth:"+newWidth);
            // console.log("schedule.style.left:"+schedule.style.left);
            // console.log("========================================");
          } else if (this.isResizingRight) {
            const newWidth = this.startWidth + event.pageX - this.startX;
            if (newWidth >= minWidth && event.pageX < window.innerWidth && this.startleft + newWidth < 1490 && newWidth % minWidth == 0) {
              this.schedule.style.width = `${newWidth}px`;
              this.showParam(newWidth);
            }
            // console.log("right");
          } else if (this.isDragging) {
            const newLeft = this.startleft + event.pageX - this.startX;
            if (newLeft >= 50 && newLeft + this.startWidth < 1490 && (newLeft - 50) % minWidth == 0) {
              this.schedule.style.left = `${newLeft}px`;
              // console.log("drag");
              // console.log(newLeft);
              this.showParam(this.startWidth);
            }
          }
        });

        document.addEventListener('mouseup', () => {
          this.isDragging = false;
          this.isResizingLeft = false;
          this.isResizingRight = false;
          this.startleft = parseInt(this.schedule.style.left);
          this.startWidth = this.schedule.clientWidth;
        });
      }

      showParam(width) {
        let starttime = parseInt(this.schedule.style.left) - 50;
        this.startP.value = Math.floor(starttime / 60).toString().padStart(2, '0') + ":" + (starttime % 60).toString().padStart(2, '0');
        this.startP.readOnly = false;
        starttime = starttime + width;
        this.endP.value = Math.floor(starttime / 60).toString().padStart(2, '0') + ":" + (starttime % 60).toString().padStart(2, '0');
        this.endP.readOnly = false;
        width = parseInt(width);
        this.totalP.textContent = "長さ：" + Math.floor(width / 60) + ":" + (width % 60).toString().padStart(2, '0');
      }

      setStartTime(value) {
        if (isTime(value)) {
          let valueToParam = convertTimeToMinutes(value);
          const newWidth = this.startleft + this.startWidth - valueToParam - 50;
          // console.log("startleft:" + this.startleft);
          // console.log("startWidth:" + this.startWidth);
          // console.log("valueToParam:" + valueToParam);
          // console.log(newWidth);
          if (newWidth > 0) {
            this.styleleft = this.startleft + this.startWidth - newWidth;
            this.schedule.style.width = `${newWidth}px`;
            this.schedule.style.left = `${this.styleleft}px`;
            this.showParam(newWidth);
          }
        }
      }

      setEndTime(value) {
        if (isTime(value)) {
          let valueToParam = convertTimeToMinutes(value);
          const newWidth = valueToParam - this.startleft + 50;
          // console.log(newWidth);
          if (newWidth >= minWidth && this.startleft + newWidth < 1490) {
            this.schedule.style.width = `${newWidth}px`;
            this.showParam(newWidth);
          }
        }
      }

      RightArrow() {
        if (this.startleft + this.startWidth + minWidth < 1490) {
          this.startleft += minWidth;
          this.schedule.style.left = this.startleft + "px";
        }
        this.showParam(this.startWidth);
      }

      LeftArrow() {
        if (this.startleft - minWidth >= 50) {
          this.startleft -= minWidth;
          this.schedule.style.left = this.startleft + "px";
        }
        this.showParam(this.startWidth);
      }

      shrinkBack() {
        if (this.startWidth - minWidth > 0) {
          this.schedule.style.width = `${this.startWidth - minWidth}px`;
          this.startWidth -= minWidth;
          this.showParam(this.startWidth);
        }
      }

      extendBack() {
        if (this.startleft + this.startWidth + minWidth < 1490) {
          this.schedule.style.width = `${this.startWidth + minWidth}px`;
          this.startWidth += minWidth;
          this.showParam(this.startWidth);
        }
      }

    }

    function isTime(str) {
      return str.match(/^([01]?[0-9]|2[0-3]):([0-5][0-9])$/) !== null;
    };

    function convertTimeToMinutes(timeString) {
      const [hours, minutes] = timeString.split(":").map(Number);
      return hours * 60 + minutes;
    }

    function findInstanceByElement(Element) {
      schedules.forEach(element => {
        if (element.schedule == Element) {
          selectedClassInstance = element;
        }
      });
    }

    function focusNext() {
      if (schedules.length > 0) {
        let indexNum = schedules.indexOf(selectedClassInstance);
        if (indexNum + 1 === schedules.length) {
          indexNum = 0;
        } else {
          indexNum += 1;
        }
        selectedClassInstance = schedules[indexNum];
        highlightElement(schedules[indexNum].schedule);
        schedules[indexNum].showParam(schedules[indexNum].startWidth);
      }
    }

    function addEvent() {
      if (limitScheduleNum > schedules.length) {
        newId += 1;

        let newSchedule = document.createElement("div");
        newSchedule.setAttribute("id", newId);
        newSchedule.classList.add("schedule");

        // スタイルを設定
        newSchedule.style.width = "60px";
        newSchedule.style.left = "110px";

        // 追加する schedule 要素を scheduleBox に追加
        const scheduleBox = document.getElementById("scheduleBox");
        scheduleBox.appendChild(newSchedule);

        schedules.push(new scheduleClass(newId));

        selectedClassInstance = schedules[schedules.length - 1];
        highlightElement(schedules[schedules.length - 1].schedule);
        schedules[schedules.length - 1].showParam(schedules[schedules.length - 1].startWidth);
      }

      if (limitScheduleNum <= schedules.length) {
        document.getElementById("add").disabled = true;
      }
    }

    // function focusBack() {
    //   if (schedules.length > 0) {
    //     let indexNum = schedules.indexOf(selectedClassInstance);
    //     if (indexNum === 0) {
    //       indexNum = schedules.length - 1;
    //     } else {
    //       indexNum -= 1;
    //     }
    //     selectedClassInstance = schedules[indexNum];
    //     highlightElement(schedules[indexNum].schedule);
    //   }
    // }

    // function deleteMethod(index){
    //   schedules.splice(index,1);
    //   console.log(schedules);
    // }

  </script>
</body>

</html>